<!DOCTYPE html>
<html>

<head>
    <script src="https://d3js.org/d3.v5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.9.1/d3-tip.js"></script>
    <title>D3 Gantt Chart</title>

    <style>
        
        #chart-container {
            display: flex;
        }

        #myDiv {
            flex: 0 0 80%; /* 80% width, do not grow or shrink */
        }

        #title-container {
            flex: 0 0 20%; /* 20% width, do not grow or shrink */
            overflow-y: auto;
            background-color: #f9f9f9;
            padding: 10px;
            box-sizing: border-box;
        }

        .title-box {
            width: 100%;
            overflow-wrap: break-word;
            white-space: wrap;
            text-overflow: ellipsis;
            margin: 5px;
        }


        #xAxis {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
            width: 100%;
        }

        .d3-tip {
            line-height: 1;
            font-weight: bold;
            padding: 12px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 2px;
        }
        #backButton {
         position: absolute;
         top: 10px;
         right: 10px;
         padding: 10px;
         cursor: pointer;
         background-color: #808080;
         color: white;
         z-index: 2; /* Add this line */
        
         .active {
            background-color: #808080;
            }
        }
    </style>
</head>

<body>
    <button id="backButton">Home</button>
    <div id="chart-container">
        <div id="myDiv">
            <h2>Top Most Frequently Occurring and Well Known Creators - Gantt Chart</h2>
            <div id="myDiv">
                <svg></svg>
            </div>
            <svg id="xAxis" width="100%" height="50"></svg>
        </div>
        <div id="title-container"></div>
    </div>

    <script>
        var backButton = document.getElementById("backButton");
 
        if (backButton) {
            backButton.addEventListener("click", function () {
                window.location.href = 'home.html';
            });
        } else {
            console.log("Button not found");
        }  
        // Add your JavaScript code here
        document.addEventListener("DOMContentLoaded", function () {
            var dataPath = "merged_data.csv"; // Updated data file path to the merged CSV
            d3.csv(dataPath).then(function (mergedData) {
                // Parsing date strings to JavaScript Date objects
                mergedData.forEach(function (d) {
                    d.earliest_year = new Date(d.earliest_year, 0, 1);
                    d.latest_year = new Date(d.latest_year, 0, 1);
                });

                mergedData.sort(function (a, b) {
                    return a.earliest_year - b.earliest_year;
                });

                var tip = d3.tip()
                    .attr('class', 'd3-tip')
                    .offset([-10, 0])
                    .html(function (d) {
                        if (this.classList.contains('rect')) {
                            return "<strong>Author:</strong> " + d.Creator + "<br>" +
                                "<strong>Frequency:</strong> " + d.Frequency + "<br>";
                        } else if (this.classList.contains('circle')) {
                            var index = mergedData.findIndex(function (entry) {
                                return entry.Creator === d.author && entry.Years.includes(d.year);
                            });

                            if (index !== -1 && mergedData[index].Titles) {
                                var titlesString = mergedData[index].Titles.replace(/'/g, '"');
                                var titles = titlesString.slice(1, -1).split('", "');
                                var titleIndex = mergedData[index].Years.indexOf(d.year);
                                var title = titles[titleIndex];
                                return "<strong>Author:</strong> " + d.author + "<br>" +
                                    "<strong>Frequency:</strong> " + d.frequency + "<br>" +
                                    "<strong>Year:</strong> " + d.year + "<br>" +
                                    "<strong>Title:</strong> " + title;
                            } else {
                                return "<strong>Author:</strong> " + d.author + "<br>" +
                                    "<strong>Frequency:</strong> " + d.frequency + "<br>" +
                                    "<strong>Year:</strong> " + d.year;
                            }
                        }
                    });

                // Creating SVG element
                var margin = { left: 80, top: 20, right: 20, bottom: 20 };
                var svg = d3.select("#myDiv svg")
                    .attr("width", 1400)
                    .attr("height", 9000);

                // Creating scale for x-axis (time)
                var xScale = d3.scaleTime()
                    .domain([d3.min(mergedData, function (d) { return d.earliest_year; }),
                    d3.max(mergedData, function (d) { return d.latest_year; })])
                    .range([margin.left, svg.attr("width") - margin.right]);

                // Creating color scale based on frequency
                var colorScale = d3.scaleSequential(d3.interpolateGreens)
                    .domain([d3.max(mergedData, function (d) { return +d.Frequency; }), 0]);

                // Adding rectangles to represent Gantt bars
                var bars = svg.selectAll("rect")
                    .data(mergedData)
                    .enter()
                    .append("rect")
                    .attr("class", "rect")
                    .attr("x", function (d) { return xScale(d.earliest_year); })
                    .attr("y", function (d, i) { return i * 30; })
                    .attr("width", function (d) {
                        return Math.max(10, xScale(d.latest_year) - xScale(d.earliest_year));
                    })
                    .attr("height", 20)
                    .attr("fill", function (d) { return colorScale(+d.Frequency); })
                    .on('click', function (d) {
                        showTitlesForAuthor(d.Creator);
                    })
                    .call(tip)
                    .on('mouseover', tip.show)
                    .on('mouseout', tip.hide);

                // Adding x-axis
                var xAxis = d3.axisBottom(xScale);
                svg.append("g")
                    .attr("transform", "translate(0," + mergedData.length * 30 + ")")
                    .call(xAxis);
            
            
                // Adding circles on top of each bar for representing years
                svg.selectAll("g.circles")
                    .data(mergedData)
                    .enter()
                    .append("g")
                    .attr("class", "circles")
                    .selectAll("circle")
                    .data(function (d) {
                        if (typeof d.Years === "string") {
                            d.Years = JSON.parse(d.Years);
                        }
                        if (Array.isArray(d.Years)) {
                            return d.Years.map(function (year) {
                                return {
                                    author: d.Creator,
                                    year: year,
                                    frequency: d.Frequency
                                };
                            });
                        } else {
                            return [];
                        }
                    })
                    .enter()
                    .append("circle")
                    .attr("class", "circle")
                    .attr("cx", function (d) {
                        return xScale(new Date(d.year, 0, 1));
                    })
                    .attr("cy", function (d) {
                        return (mergedData.findIndex(function (author) {
                            return author.Creator === d.author;
                        })) * 30 + 10;
                    })
                    .attr("r", 5)
                    .attr("fill", "red")
                    .attr("opacity", 0.7) // Set the opacity (0 is fully transparent, 1 is fully opaque)
                    .attr("stroke", "black") // Set the outline color
                    .attr("stroke-width", 1) // Set the outline width
                    .call(tip)
                    .on('mouseover', tip.show)
                    .on('mouseout', tip.hide)
                    .on('click', function (d) {
                        highlightTitleForAuthor(d.author, d.year);
                    });


                // Adding text labels (creator names) to the left of each bar
                svg.selectAll("text")
                    .data(mergedData)
                    .enter()
                    .append("text")
                    .attr("x", function (d) { return xScale(d.earliest_year) - 5; })
                    .attr("y", function (d, i) { return i * 30 + 15; })
                    .text(function (d) { return d.Creator; })
                    .attr("text-anchor", "end")
                    .attr("dy", ".35em")
                    .style("font-size", "12px");

                // Adding x-axis separately for fixed positioning
                var xAxisContainer = d3.select("#xAxis");
                var fixedXAxis = d3.axisBottom(xScale);
                xAxisContainer.append("g")
                    .call(fixedXAxis);

                // Adding Legend
                var legend = svg.append("g")
                    .attr("transform", "translate(" + (svg.attr("width") - 80) + "," + 20 + ")");

                // Legend Title
                legend.append("text")
                    .attr("x", 0)
                    .attr("y", -10)
                    .text("Frequency")
                    .attr("class", "legend-title");

                // Legend Color Rectangles
                legend.selectAll("rect")
                    .data(colorScale.ticks(5))
                    .enter()
                    .append("rect")
                    .attr("x", 0)
                    .attr("y", function (d, i) { return i * 20; })
                    .attr("width", 15)
                    .attr("height", 15)
                    .style("fill", function (d) { return colorScale(d); });

                // Legend Labels
                legend.selectAll("text.legend")
                    .data(colorScale.ticks(5))
                    .enter()
                    .append("text")
                    .attr("x", 20)
                    .attr("y", function (d, i) { return i * 20 + 10; })
                    .text(function (d) { return d; })
                    .attr("dy", "0.7em")
                    .style("font-size", "12px")
                    .style("fill", "#555")
                    .attr("class", "legend");

                // Handle click event to show titles
                function showTitlesForAuthor(author) {
                    var titlesContainer = d3.select("#title-container");
                    titlesContainer.selectAll(".title-box").remove();
                    console.log("pressed", author);
                    var authorData = mergedData.find(function (entry) {
                        return entry.Creator === author;
                    });

                    if (authorData && authorData.Titles) {
                        console.log("clickeddd")
                        var titlesString = authorData.Titles.replace(/'/g, '"');
                        var titles = titlesString.slice(1, -1).split('", "');

                        titlesContainer.selectAll(".title-box")
                            .data(titles)
                            .enter()
                            .append("div")
                            .attr("class", "title-box")
                            .text(function (title) { return title; });
                        
                    titlesContainer.style("display", titlesContainer.selectAll(".title-box").size() > 0 ? "block" : "none");
                    }
                }
                
                // Handle click event to highlight title
                function highlightTitleForAuthor(author, year) {
                    var titlesContainer = d3.select("#title-container");
                    titlesContainer.selectAll(".title-box").remove();

                    var authorData = mergedData.find(function (entry) {
                        return entry.Creator === author;
                    });

                    if (authorData && authorData.Titles) {
                        var titlesString = authorData.Titles.replace(/'/g, '"');
                        var titles = titlesString.slice(1, -1).split('", "');

                        titlesContainer.selectAll(".title-box")
                            .data(titles)
                            .enter()
                            .append("div")
                            .attr("class", "title-box")
                            .text(function (title) { return title; })
                            .style("background-color", function (title) {
                                return title.includes(year) ? "red" : "black";
                            })
                            .style("background-color", "transparent"); // Set background color to transparent
                    }

                    titlesContainer.style("display", titlesContainer.selectAll(".title-box").size() > 0 ? "block" : "none");
                }


                
            });
        });
    </script>
</body>

</html>
